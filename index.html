const express = require('express');
const { Telegraf } = require('telegraf');
const fs = require('fs');
const app = express();

// --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
const BOT_TOKEN = 'Ø¶Ø¹_ØªÙˆÙƒÙ†_Ø¨ÙˆØªÙƒ_Ù‡Ù†Ø§'; 
const BOT_URL = 'https://t.me/MTM_coin_bot'; // Ø±Ø§Ø¨Ø· Ø¨ÙˆØªÙƒ Ù‡Ù†Ø§
const CHANNEL_LINK = 'https://t.me/MTM_coin';
const bot = new Telegraf(BOT_TOKEN);

app.use(express.json());

// --- Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ· ---
let db = { users: {} };
if (fs.existsSync('db.json')) db = JSON.parse(fs.readFileSync('db.json'));

function saveDB() { fs.writeFileSync('db.json', JSON.stringify(db)); }

// --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (HTML + CSS + JS) ---
app.get('/', (req, res) => {
    res.send(`
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MTM Coin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #ffcc00; --bg: #0a0a12; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); }
        .user-info { font-size: 14px; color: #aaa; }
        
        .score-section { text-align: center; margin-top: 30px; }
        #balance { font-size: 50px; font-weight: bold; color: var(--gold); text-shadow: 0 0 20px rgba(255,204,0,0.4); }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ù‚Ø± */
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #coin { width: 250px; height: 250px; cursor: pointer; transition: transform 0.05s; user-select: none; z-index: 10; }
        #coin:active { transform: scale(0.9); }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù†Ù‚Ø± */
        .plus-one { position: absolute; color: var(--gold); font-size: 28px; font-weight: bold; animation: floatUp 0.7s forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-120px); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .nav-bar { display: flex; background: #161625; padding: 15px 0; border-top: 2px solid #222; }
        .nav-item { flex: 1; text-align: center; color: #888; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--gold); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 5px; }

        /* Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ© */
        .page { display: none; padding: 20px; height: 80vh; overflow-y: auto; }
        .page.active { display: block; }
        .card { background: #1c1c2e; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn { background: var(--gold); color: black; padding: 8px 15px; border-radius: 8px; font-weight: bold; text-decoration: none; border:none;}
    </style>
</head>
<body>

    <div id="game-page" class="page active">
        <div class="header">
            <div class="user-info">ID: <span id="uid">...</span></div>
            <div class="user-info">MTM Player</div>
        </div>
        <div class="score-section">
            <div id="balance">0</div>
            <div style="color:#888">MTM COINS</div>
        </div>
        <div class="game-area">
            <img src="https://i.ibb.co/L1mP94w/mtm-coin.png" id="coin" alt="MTM">
        </div>
    </div>

    <div id="tasks-page" class="page">
        <h2>Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª</h2>
        <div class="card">
            <div>
                <b>Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙˆØª</b><br>
                <small>+50,000 MTM</small>
            </div>
            <button class="btn" onclick="completeTask(1, 50000)">Ø¥ØªÙ…Ø§Ù…</button>
        </div>
        <div class="card">
            <div>
                <b>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙŠÙˆÙ…ÙŠ</b><br>
                <small>+1,000 MTM</small>
            </div>
            <button class="btn" onclick="completeTask('daily', 1000)">Ø§Ø³ØªÙ„Ø§Ù…</button>
        </div>
    </div>

    <div id="ref-page" class="page">
        <h2>Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h2>
        <div class="card" style="flex-direction: column; text-align: center;">
            <p>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 10,000 Ø¹Ù…Ù„Ø© Ø¹Ù† ÙƒÙ„ ØµØ¯ÙŠÙ‚!</p>
            <input type="text" id="ref-link" readonly style="width:100%; padding:10px; background:#0a0a12; border:1px solid #333; color:white; border-radius:5px;">
            <button class="btn" style="margin-top:10px; width:100%" onclick="copyRef()">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showPage('game-page', this)"><i class="fas fa-coins"></i>Ù†Ù‚Ø±</div>
        <div class="nav-item" onclick="showPage('tasks-page', this)"><i class="fas fa-tasks"></i>Ù…Ù‡Ø§Ù…</div>
        <div class="nav-item" onclick="showPage('ref-page', this)"><i class="fas fa-users"></i>Ø¥Ø­Ø§Ù„Ø©</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user?.id || 12345;
        document.getElementById('uid').innerText = userId;
        document.getElementById('ref-link').value = "${BOT_URL}?start=" + userId;

        let balance = 0;

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        const coin = document.getElementById('coin');
        coin.addEventListener('touchstart', (e) => {
            e.preventDefault();
            balance += 1;
            document.getElementById('balance').innerText = balance.toLocaleString();
            createPlusOne(e.touches[0].pageX, e.touches[0].pageY);
            if(balance % 20 === 0) syncData();
        });

        function createPlusOne(x, y) {
            const p = document.createElement('div');
            p.className = 'plus-one';
            p.innerText = '+1';
            p.style.left = x + 'px'; p.style.top = y + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 700);
        }

        async function syncData() {
            await fetch('/sync', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, balance })
            });
        }

        async function completeTask(type, reward) {
            alert('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ' + reward);
            balance += reward;
            document.getElementById('balance').innerText = balance.toLocaleString();
            syncData();
        }

        function copyRef() {
            const input = document.getElementById('ref-link');
            input.select();
            document.execCommand('copy');
            alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!');
        }
    </script>
</body>
</html>
    `);
});

// --- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Backend) ---

// Ø­ÙØ¸ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
app.post('/sync', (req, res) => {
    const { userId, balance } = req.body;
    if (!db.users[userId]) db.users[userId] = { balance: 0, refs: 0 };
    db.users[userId].balance = Math.max(db.users[userId].balance, balance);
    saveDB();
    res.json({ status: 'ok' });
});

// Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
bot.start((ctx) => {
    const userId = ctx.from.id;
    const refId = ctx.payload; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©

    if (!db.users[userId]) {
        db.users[userId] = { balance: 0, refs: 0, joined: Date.now() };
        if (refId && db.users[refId] && refId != userId) {
            db.users[refId].balance += 10000;
            db.users[refId].refs += 1;
            bot.telegram.sendMessage(refId, "ğŸ’° ØµØ¯ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù… Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·Ùƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 10,000 Ø¹Ù…Ù„Ø©.");
        }
    }
    saveDB();

    ctx.replyWithMarkdown(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ *MTM Coin* ğŸ’°\n\nğŸ†” Ù…Ø¹Ø±ÙÙƒ: \`${userId}\`\nğŸ“ˆ Ø±ØµÙŠØ¯Ùƒ Ù…Ø­ÙÙˆØ¸ Ø¯Ø§Ø¦Ù…Ø§Ù‹.`, {
        reply_markup: {
            inline_keyboard: [[{ text: "Ø¥ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ®", web_app: { url: "Ø±Ø§Ø¨Ø·_Ù…ÙˆÙ‚Ø¹Ùƒ_Ù‡Ù†Ø§" } }]]
        }
    });
});

bot.launch();
app.listen(3000, () => console.log('MTM Coin running...'));
