<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MTM Coin - Official App</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: linear-gradient(135deg, #ffcc00, #ff9900); --bg: #050508; --card: #121220; --accent: #ffcc00; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none; direction: rtl; }
        
        #lang-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .header { padding: 15px; background: var(--card); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .content { height: 75vh; overflow-y: auto; padding-bottom: 80px; }
        
        #balance-container { text-align: center; padding: 25px 0; }
        #balance { font-size: 42px; font-weight: 900; background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .coin-wrapper { position: relative; display: flex; justify-content: center; align-items: center; height: 220px; }
        #coin { width: 190px; height: 190px; cursor: pointer; transition: transform 0.1s; border-radius: 50%; filter: drop-shadow(0 0 15px rgba(255,204,0,0.3)); }
        #coin:active { transform: scale(0.92); }
        .tap-pop { position: absolute; color: gold; font-size: 26px; font-weight: bold; pointer-events: none; animation: float 0.7s forwards; }
        @keyframes float { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-120px); } }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #0a0a15; display: flex; border-top: 1px solid #333; padding: 12px 0; z-index: 900; }
        .nav-item { flex: 1; text-align: center; color: #555; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 20px; margin-bottom: 3px; }

        .page { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid #222; }
        .card-info { flex-grow: 1; margin: 0 15px; }
        .btn-action { background: var(--gold); color: black; border: none; padding: 10px 18px; border-radius: 12px; font-weight: bold; }
        .btn-action:disabled { background: #333; color: #777; }
        
        .energy-status { width: 80%; height: 10px; background: #1a1a2a; border-radius: 10px; margin: 15px auto; overflow: hidden; }
        #energy-fill { height: 100%; background: var(--gold); width: 100%; transition: width 0.3s; }
    </style>
</head>
<body>

<div id="lang-overlay">
    <h1 style="color:gold; letter-spacing: 2px;">MTM COIN</h1>
    <button class="btn-action" style="width:200px" onclick="setLanguage('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <button class="btn-action" style="width:200px" onclick="setLanguage('en')">English</button>
</div>

<div class="header">
    <div id="u-id" style="font-size: 10px; color: #777;">ID: ...</div>
    <div id="u-name" style="font-weight: bold; color: gold;">MTM Player</div>
</div>

<div class="content">
    <div id="page-tap" class="page active">
        <div id="balance-container">
            <small id="txt-balance-label" style="color:#777">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯</small>
            <div id="balance">0</div>
        </div>
        <div class="coin-wrapper">
            <img src="coin.png" id="coin" onpointerdown="handleTap(event)" onerror="this.src='https://cdn-icons-png.flaticon.com/512/217/217853.png'">
        </div>
        <div style="text-align: center; margin-top:20px">
            <div style="font-size:14px">âš¡ <span id="energy-val">1000/1000</span></div>
            <div class="energy-status"><div id="energy-fill"></div></div>
        </div>
    </div>

    <div id="page-boost" class="page">
        <h2 id="txt-boost-head">Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª âš¡</h2>
        <div class="card">
            <i class="fas fa-hand-pointer" style="color:gold; font-size:24px"></i>
            <div class="card-info"><b id="txt-multitap">Ù‚ÙˆØ© Ø§Ù„Ù†Ù‚Ø±Ø©</b><br><small id="lv-tap">Level 1</small></div>
            <button class="btn-action" id="btn-up-tap" onclick="buyBooster('tap')">500</button>
        </div>
        <div class="card">
            <i class="fas fa-battery-full" style="color:gold; font-size:24px"></i>
            <div class="card-info"><b id="txt-energy-limit">Ø³Ø¹Ø© Ø§Ù„Ø·Ø§Ù‚Ø©</b><br><small id="lv-energy">Level 1</small></div>
            <button class="btn-action" id="btn-up-energy" onclick="buyBooster('energy')">1000</button>
        </div>
    </div>

    <div id="page-task" class="page">
        <h2 id="txt-task-head">Ø§Ù„Ù…Ù‡Ø§Ù… ğŸš€</h2>
        <div class="card">
            <i class="fab fa-telegram" style="font-size:24px"></i>
            <div class="card-info"><b>Telegram</b><br><small>+50,000</small></div>
            <button class="btn-action" id="btn-task-tg" onclick="completeTask('tg', 50000, 'https://t.me/MTM_coin')">Go</button>
        </div>
    </div>

    <div id="page-rank" class="page">
        <h2 id="txt-rank-head">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† ğŸ†</h2>
        <div id="rank-container">Loading...</div>
    </div>

    <div id="page-ref" class="page">
        <h2 id="txt-ref-head">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ‘¥</h2>
        <div class="card" style="flex-direction: column; text-align: center;">
            <p id="txt-ref-desc">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 50,000 Ø¹Ù† ÙƒÙ„ Ø¥Ø­Ø§Ù„Ø©</p>
            <input type="text" id="ref-link-field" readonly style="width:90%; padding:10px; background:#000; border:1px solid #333; color:gold; border-radius:10px; text-align:center; margin-bottom:10px;">
            <button class="btn-action" style="width:100%" onclick="copyRef()">Copy Link</button>
        </div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="nav('page-tap', this)"><i class="fas fa-coins"></i><br><span id="n-tap">ØªØ¹Ø¯ÙŠÙ†</span></div>
    <div class="nav-item" onclick="nav('page-boost', this)"><i class="fas fa-bolt"></i><br><span id="n-boost">ØªØ·ÙˆÙŠØ±</span></div>
    <div class="nav-item" onclick="nav('page-task', this)"><i class="fas fa-tasks"></i><br><span id="n-task">Ù…Ù‡Ø§Ù…</span></div>
    <div class="nav-item" onclick="nav('page-rank', this); loadRanking()"><i class="fas fa-trophy"></i><br><span id="n-rank">ØªØ±ØªÙŠØ¨</span></div>
    <div class="nav-item" onclick="nav('page-ref', this)"><i class="fas fa-users"></i><br><span id="n-ref">Ø¥Ø­Ø§Ù„Ø©</span></div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = { 
    apiKey: "AIzaSyA1Nnh0P7RdWH7EhBnaGkk6QUNeWRXPKt8", 
    databaseURL: "https://mtm-coin-a52d9-default-rtdb.firebaseio.com" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tg = window.Telegram.WebApp;
tg.expand();

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "777";
const userName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "Player";
let data = { score: 0, energy: 1000, maxE: 1000, tap: 1, upT: 0, upE: 0, tasks: {tg: false} };

const dictionary = {
    ar: { bLabel:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯", bHead:"Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª", mtap:"Ù‚ÙˆØ© Ø§Ù„Ù†Ù‚Ø±Ø©", elimit:"Ø³Ø¹Ø© Ø§Ù„Ø·Ø§Ù‚Ø©", tHead:"Ø§Ù„Ù…Ù‡Ø§Ù…", rHead:"Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†", fHead:"Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡", fDesc:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 50,000 Ø¹Ù† ÙƒÙ„ Ø¥Ø­Ø§Ù„Ø©", n1:"ØªØ¹Ø¯ÙŠÙ†", n2:"ØªØ·ÙˆÙŠØ±", n3:"Ù…Ù‡Ø§Ù…", n4:"ØªØ±ØªÙŠØ¨", n5:"Ø¥Ø­Ø§Ù„Ø©", done:"Ù…ÙƒØªÙ…Ù„" },
    en: { bLabel:"Total Balance", bHead:"Upgrades", mtap:"Multitap", elimit:"Energy Limit", tHead:"Tasks", rHead:"Leaderboard", fHead:"Friends", fDesc:"Get 50,000 per referral", n1:"Tap", n2:"Boost", n3:"Tasks", n4:"Rank", n5:"Ref", done:"Done" }
};

let currentLang = localStorage.getItem('lang');
if(currentLang) { 
    document.getElementById('lang-overlay').style.display = 'none';
    applyTexts();
}

function setLanguage(l) {
    currentLang = l;
    localStorage.setItem('lang', l);
    document.getElementById('lang-overlay').style.display = 'none';
    applyTexts();
}

function applyTexts() {
    const l = dictionary[currentLang || 'ar'];
    document.body.style.direction = (currentLang === 'ar' ? 'rtl' : 'ltr');
    document.getElementById('txt-balance-label').innerText = l.bLabel;
    document.getElementById('txt-boost-head').innerText = l.bHead;
    document.getElementById('txt-multitap').innerText = l.mtap;
    document.getElementById('txt-energy-limit').innerText = l.elimit;
    document.getElementById('txt-task-head').innerText = l.tHead;
    document.getElementById('txt-rank-head').innerText = l.rHead;
    document.getElementById('txt-ref-head').innerText = l.fHead;
    document.getElementById('txt-ref-desc').innerText = l.fDesc;
    document.getElementById('n-tap').innerText = l.n1; document.getElementById('n-boost').innerText = l.n2;
    document.getElementById('n-task').innerText = l.n3; document.getElementById('n-rank').innerText = l.n4;
    document.getElementById('n-ref').innerText = l.n5;
    updateView();
}

function updateView() {
    document.getElementById('balance').innerText = Math.floor(data.score).toLocaleString();
    document.getElementById('energy-val').innerText = `${Math.floor(data.energy)}/${data.maxE}`;
    document.getElementById('energy-fill').style.width = (data.energy/data.maxE*100) + "%";
    document.getElementById('u-id').innerText = "ID: " + userId;
    document.getElementById('u-name').innerText = userName;
    document.getElementById('lv-tap').innerText = "Level " + (data.upT + 1);
    document.getElementById('lv-energy').innerText = "Level " + (data.upE + 1);
    document.getElementById('btn-up-tap').innerText = (500 * (data.upT + 1));
    document.getElementById('btn-up-energy').innerText = (1000 * (data.upE + 1));
    document.getElementById('ref-link-field').value = `https://t.me/MTM_Coin_App_Bot?start=${userId}`;
    if(data.tasks && data.tasks.tg) { 
        document.getElementById('btn-task-tg').innerText = dictionary[currentLang||'ar'].done;
        document.getElementById('btn-task-tg').disabled = true;
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ - Ù†Ø³ØªØ®Ø¯Ù… update Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function save() { 
    db.ref('users/' + userId).update({ 
        score: data.score, 
        energy: data.energy,
        maxE: data.maxE,
        tap: data.tap,
        upT: data.upT,
        upE: data.upE,
        tasks: data.tasks,
        name: userName,
        lastSeen: Date.now()
    }); 
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
db.ref('users/' + userId).once('value', s => {
    if(s.exists()) {
        data = { ...data, ...s.val() };
    } else {
        save();
    }
    updateView();
    if(currentLang) applyTexts();
});

function handleTap(e) {
    if(data.energy < data.tap) return;
    data.score += data.tap;
    data.energy -= data.tap;
    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    
    let pop = document.createElement('div');
    pop.className = 'tap-pop';
    pop.innerText = "+" + data.tap;
    pop.style.left = (e.clientX || e.touches[0].clientX) + "px";
    pop.style.top = (e.clientY || e.touches[0].clientY) + "px";
    document.body.appendChild(pop);
    setTimeout(() => pop.remove(), 700);
    updateView();
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒØ§Ø­ØªÙŠØ§Ø·
setInterval(save, 5000);

function buyBooster(type) {
    let cost = (type === 'tap') ? 500*(data.upT+1) : 1000*(data.upE+1);
    if(data.score >= cost) {
        data.score -= cost;
        if(type === 'tap') { data.tap++; data.upT++; }
        else { data.maxE += 500; data.upE++; data.energy = data.maxE; }
        updateView(); 
        save();
    }
}

function loadRanking() {
    const cont = document.getElementById('rank-container');
    cont.innerHTML = "Fetching...";
    db.ref('users').orderByChild('score').limitToLast(10).once('value', s => {
        cont.innerHTML = "";
        let list = []; s.forEach(c => { list.push(c.val()); });
        list.reverse().forEach((p, i) => {
            cont.innerHTML += `<div class="card"><b>#${i+1}</b><div class="card-info">${p.name || 'User'}</div><b>${Math.floor(p.score).toLocaleString()}</b></div>`;
        });
    });
}

function completeTask(t, r, l) {
    tg.openLink(l);
    setTimeout(() => { 
        if(!data.tasks[t]) { 
            data.score += r; 
            if(!data.tasks) data.tasks = {};
            data.tasks[t] = true; 
            updateView(); 
            save(); 
        } 
    }, 4000);
}

function nav(id, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
}

function copyRef() {
    const f = document.getElementById('ref-link-field');
    f.select();
    navigator.clipboard.writeText(f.value);
    tg.showAlert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø·Ø§Ù‚Ø©
setInterval(() => { 
    if(data.energy < data.maxE) { 
        data.energy = Math.min(data.maxE, data.energy + 1.5); 
        updateView(); 
    } 
}, 1000);

// Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯Ø¹ÙˆÙ…Ø§Ù‹
window.addEventListener('beforeunload', save);
</script>
</body>
</html>
