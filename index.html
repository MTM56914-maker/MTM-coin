<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MTM Coin - Legend Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --gold: linear-gradient(135deg, #ffcc00, #ff9900);
            --bg: #050508;
            --card-bg: #121220;
            --accent: #ffcc00;
        }

        body {
            background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif;
            margin: 0; overflow: hidden; -webkit-user-select: none; user-select: none;
            touch-action: manipulation; direction: rtl;
            -webkit-tap-highlight-color: transparent; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø²Ø±Ù‚ */
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            padding: 15px; background: rgba(22, 22, 37, 0.8); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222;
        }

        #balance-container { text-align: center; margin: 20px 0; }
        #balance {
            font-size: 40px; font-weight: 900; background: var(--gold);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* Ø§Ù„Ø¹Ù…Ù„Ø© */
        .coin-wrapper { position: relative; display: flex; justify-content: center; align-items: center; height: 240px; }
        #coin {
            width: 200px; height: 200px; cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 0 15px rgba(255, 204, 0, 0.2));
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        #coin:active { transform: scale(0.95); }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù†Ù‚Ø±Ø§Øª */
        .tap-effect {
            position: absolute; color: #ffcc00; font-size: 24px; font-weight: bold;
            pointer-events: none; animation: floatUp 0.6s ease-out forwards; z-index: 100;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }

        /* Ø§Ù„ØµÙØ­Ø§Øª */
        .page { display: none; padding: 20px; height: 75vh; overflow-y: auto; padding-bottom: 120px; }
        .page.active { display: block; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ Ø§Ù„ØªØ·ÙˆÙŠØ±) */
        .card {
            background: var(--card-bg); padding: 12px; border-radius: 12px;
            margin-bottom: 10px; display: flex; align-items: center; border: 1px solid #222;
        }
        .card i { font-size: 20px; margin-left: 12px; color: var(--accent); }
        .info { flex-grow: 1; text-align: right; }
        .rank-num { font-weight: bold; margin-left: 10px; color: gold; width: 30px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            background: var(--gold); color: #000; padding: 8px 14px; border-radius: 8px;
            font-weight: bold; border: none; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .btn:disabled { background: #444; color: #888; }

        /* Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
        .nav-bar {
            position: fixed; bottom: 10px; left: 5%; width: 90%;
            display: flex; background: rgba(18, 18, 32, 0.95); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 8px 0; border: 1px solid #333; z-index: 1000;
        }
        .nav-item { flex: 1; text-align: center; color: #777; font-size: 11px; -webkit-tap-highlight-color: transparent; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø·Ø§Ù‚Ø© */
        .energy-bar-container { width: 80%; height: 8px; background: #222; border-radius: 10px; margin: 10px auto; overflow: hidden; }
        #energy-fill { height: 100%; width: 100%; background: var(--gold); transition: width 0.3s; }
    </style>
</head>
<body>

<div class="header">
    <div id="level-txt">MTM Coin</div>
    <button id="lang-btn" class="btn" onclick="toggleLang()" style="padding: 2px 8px; font-size: 10px;">EN / Ø¹Ø±Ø¨ÙŠ</button>
</div>

<div id="game-page" class="page active">
    <div id="balance-container">
        <div id="balance-label" style="font-size:12px; color:#aaa;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</div>
        <div id="balance">0</div>
    </div>
    <div class="coin-wrapper">
        <img src="https://cdn-icons-png.flaticon.com/512/6001/6001527.png" id="coin" onpointerdown="handleTap(event)">
    </div>
    <div style="text-align: center;">
        <div style="margin-bottom: 5px;"><span id="energy-label">Ø§Ù„Ø·Ø§Ù‚Ø©</span>: <span id="energy-txt">1000/1000</span></div>
        <div class="energy-bar-container"><div id="energy-fill"></div></div>
    </div>
    <div class="card" style="margin-top: 20px;">
        <i class="fas fa-calendar-check"></i>
        <div class="info">
            <b id="daily-title">Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ©</b><br>
            <small id="daily-desc">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 5,000 ÙƒÙˆÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹</small>
        </div>
        <button class="btn" id="daily-btn" onclick="claimDaily()">Claim</button>
    </div>
</div>

<div id="boost-page" class="page">
    <h2 id="boost-title">Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª âš¡</h2>
    <div class="card">
        <i class="fas fa-hand-pointer"></i>
        <div class="info"><b id="tap-boost-name">Ù‚ÙˆØ© Ø§Ù„Ù†Ù‚Ø±Ø©</b><br><small id="tap-boost-desc">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† ÙƒÙ„ Ù†Ù‚Ø±Ø©</small></div>
        <button class="btn" onclick="buyUpgrade('tap')"><span id="tap-price">500</span></button>
    </div>
    <div class="card">
        <i class="fas fa-battery-full"></i>
        <div class="info"><b id="energy-boost-name">Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø·Ø§Ù‚Ø©</b><br><small id="energy-boost-desc">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰</small></div>
        <button class="btn" onclick="buyUpgrade('energy')"><span id="energy-price">1000</span></button>
    </div>
</div>

<div id="leaderboard-page" class="page">
    <h2 id="rank-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†</h2>
    <div id="leaderboard-list">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨...
    </div>
</div>

<div id="tasks-page" class="page">
    <h2 id="tasks-title">Ø§Ù„Ù…Ù‡Ø§Ù… ğŸš€</h2>
    <div class="card">
        <i class="fab fa-telegram"></i>
        <div class="info"><b>Telegram Channel</b><br><small>+50,000</small></div>
        <button class="btn" onclick="doTask('tg', 50000, 'https://t.me/MTM_coin')">Go</button>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="showP('game-page',this)"><i class="fas fa-coins"></i><br><span id="nav-tap">Ù†Ù‚Ø±</span></div>
    <div class="nav-item" onclick="showP('boost-page',this)"><i class="fas fa-bolt"></i><br><span id="nav-boost">ØªØ·ÙˆÙŠØ±</span></div>
    <div class="nav-item" onclick="showP('leaderboard-page',this)"><i class="fas fa-trophy"></i><br><span id="nav-rank">ØªØ±ØªÙŠØ¨</span></div>
    <div class="nav-item" onclick="showP('tasks-page',this)"><i class="fas fa-tasks"></i><br><span id="nav-task">Ù…Ù‡Ø§Ù…</span></div>
</nav>

<script>
// --- ØªÙƒÙˆÙŠÙ† Firebase ---
const firebaseConfig = { 
    apiKey: "AIzaSyA1Nnh0P7RdWH7EhBnaGkk6QUNeWRXPKt8", 
    databaseURL: "https://mtm-coin-a52d9-default-rtdb.firebaseio.com" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tg = window.Telegram.WebApp;
const user = tg.initDataUnsafe.user || { id: "Guest", first_name: "Player" };

let userData = {
    score: 0, energy: 1000, maxEnergy: 1000, tapPower: 1,
    upgrades: { tap: 0, energy: 0 }, lastDaily: 0,
    name: user.first_name, tasks: {}
};

let currentLang = localStorage.getItem('lang') || 'ar';
const langStrings = {
    ar: { balance: "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ", energy: "Ø§Ù„Ø·Ø§Ù‚Ø©", daily: "Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ©", boost: "Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª âš¡", rank: "Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† ğŸ†", navTap: "Ù†Ù‚Ø±", navBoost: "ØªØ·ÙˆÙŠØ±", navRank: "ØªØ±ØªÙŠØ¨", navTask: "Ù…Ù‡Ø§Ù…" },
    en: { balance: "TOTAL BALANCE", energy: "Energy", daily: "Daily Reward", boost: "Upgrades âš¡", rank: "Leaderboard ğŸ†", navTap: "Tap", navBoost: "Boost", navRank: "Rank", navTask: "Tasks" }
};

function toggleLang() {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    localStorage.setItem('lang', currentLang);
    updateUI();
}

function updateUI() {
    const l = langStrings[currentLang];
    document.body.style.direction = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('balance-label').innerText = l.balance;
    document.getElementById('energy-label').innerText = l.energy;
    document.getElementById('daily-title').innerText = l.daily;
    document.getElementById('boost-title').innerText = l.boost;
    document.getElementById('rank-title').innerText = l.rank;
    document.getElementById('nav-tap').innerText = l.navTap;
    document.getElementById('nav-boost').innerText = l.navBoost;
    document.getElementById('nav-rank').innerText = l.navRank;
    document.getElementById('nav-task').innerText = l.navTask;

    document.getElementById('balance').innerText = Math.floor(userData.score).toLocaleString();
    document.getElementById('energy-txt').innerText = `${Math.floor(userData.energy)}/${userData.maxEnergy}`;
    document.getElementById('energy-fill').style.width = `${(userData.energy/userData.maxEnergy)*100}%`;
    document.getElementById('tap-price').innerText = (500 * (userData.upgrades.tap + 1)).toLocaleString();
    document.getElementById('energy-price').innerText = (1000 * (userData.upgrades.energy + 1)).toLocaleString();
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø± ---
function handleTap(e) {
    if(userData.energy < userData.tapPower) return;
    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

    userData.score += userData.tapPower;
    userData.energy -= userData.tapPower;
    
    // ØªØ£Ø«ÙŠØ± Ø±Ù‚Ù…ÙŠ
    const x = e.clientX || e.touches[0].clientX;
    const y = e.clientY || e.touches[0].clientY;
    const div = document.createElement('div');
    div.className = 'tap-effect';
    div.style.left = x + 'px'; div.style.top = y + 'px';
    div.innerText = `+${userData.tapPower}`;
    document.body.appendChild(div);
    setTimeout(()=> div.remove(), 600);

    updateUI();
    saveData();
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©) ---
function loadLeaderboard() {
    const listDiv = document.getElementById('leaderboard-list');
    db.ref('users').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
        let players = [];
        snapshot.forEach((child) => {
            players.push(child.val());
        });
        players.reverse(); // Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

        listDiv.innerHTML = '';
        players.forEach((p, index) => {
            listDiv.innerHTML += `
                <div class="card">
                    <div class="rank-num">#${index + 1}</div>
                    <div class="info">
                        <b>${p.name || 'Unknown'}</b><br>
                        <small>${Math.floor(p.score).toLocaleString()} ÙƒÙˆÙŠÙ†</small>
                    </div>
                    <i class="fas fa-medal"></i>
                </div>`;
        });
    });
}

// --- Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ---
function claimDaily() {
    const now = Date.now();
    if (now - userData.lastDaily > 24 * 60 * 60 * 1000) {
        userData.score += 5000;
        userData.lastDaily = now;
        saveData();
        alert(currentLang === 'ar' ? "Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 5,000" : "Congrats! You got 5,000");
    } else {
        alert(currentLang === 'ar' ? "Ø¹Ø¯ ØºØ¯Ø§Ù‹ Ù„Ù„Ù…Ø·Ø§Ù„Ø¨Ø©!" : "Come back tomorrow!");
    }
}

// --- Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª ---
function buyUpgrade(type) {
    let cost = type === 'tap' ? 500 * (userData.upgrades.tap + 1) : 1000 * (userData.upgrades.energy + 1);
    if(userData.score >= cost) {
        userData.score -= cost;
        if(type === 'tap') { userData.tapPower++; userData.upgrades.tap++; }
        else { userData.maxEnergy += 500; userData.upgrades.energy++; }
        saveData();
        updateUI();
    }
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© ---
function showP(id, el) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
    if(id === 'leaderboard-page') loadLeaderboard();
}

function saveData() { db.ref('users/' + user.id).update(userData); }

function init() {
    db.ref('users/' + user.id).on('value', (s) => {
        if(s.exists()) { userData = {...userData, ...s.val()}; }
        updateUI();
    });
    setInterval(() => {
        if(userData.energy < userData.maxEnergy) {
            userData.energy = Math.min(userData.maxEnergy, userData.energy + 2);
            updateUI();
        }
    }, 1500);
}

init();
</script>
</body>
</html>
